name: Security Scan with Trivy & Hadolint

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write  # Required permission to update SECURITY.md

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-benchmark locust bandit safety flake8 mypy

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl
          TRIVY_VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | grep '"tag_name":' | cut -d '"' -f 4)
          wget -O trivy.tar.gz "https://github.com/aquasecurity/trivy/releases/download/${TRIVY_VERSION}/trivy_Linux_x86_64.tar.gz"
          if [ ! -s trivy.tar.gz ]; then
            echo "Error: Failed to download Trivy archive"
            exit 1
          fi
          tar -xzf trivy.tar.gz || (echo "Failed to extract Trivy" && cat trivy.tar.gz && exit 1)
          sudo mv trivy /usr/local/bin/
          rm trivy.tar.gz
      
      - name: Install Hadolint
        run: |
          wget -O hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          if [ ! -s hadolint ]; then
            echo "Error: Failed to download Hadolint binary"
            exit 1
          fi
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/
        

      - name: Run unit tests
        run: pytest --disable-warnings

      - name: Run performance tests
        run: pytest --benchmark-only

      - name: Run load tests with Locust
        run: locust -f locustfile.py --headless -u 50 -r 5 --run-time 2m

      - name: Perform security check with Bandit
        run: bandit -r .

      - name: Check dependencies for vulnerabilities with Safety
        run: safety check -r requirements.txt

      - name: Check code quality with Flake8
        run: flake8 .

      - name: Check type consistency with Mypy
        run: mypy .

      - name: Lint Dockerfile with Hadolint
        run: hadolint Dockerfile

      - name: Scan Docker image for vulnerabilities with Trivy
        run: trivy image my-docker-image
